generator client {
  provider   = "prisma-client-js"
  engineType = "library" // or "binary" (either is fine on Node)
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)

  @@index([shop]) // speeds up lookups by shop
  @@index([expires]) // helps periodic cleanup of expired sessions
}

model tblkp_staff {
  id   Int     @id @default(autoincrement())
  name String? @db.VarChar(60)
  role String? @db.VarChar(60)
  gid  String? @db.VarChar(60)

  @@map("rsl_staff")
}

/**
 * Core shipment data
 */
model tbl_shipment {
  id                        Int       @id @default(autoincrement())
  companyId                 String
  companyName               String
  containerNumber           String    @unique
  containerSize             String?
  portOfOrigin              String?
  destinationPort           String?
  deliveryAddress           String?
  etaDate                   DateTime?
  cargoReadyDate            DateTime?
  estimatedDeliveryToOrigin DateTime?
  supplierPi                String?
  quantity                  BigInt?
  bookingAgent              String?
  bookingNumber             String?
  vesselName                String?
  status                    String?
  notes                     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- Relations ---
  company               tlkp_company?         @relation(fields: [companyId], references: [shortName])
  container             tlkp_container?       @relation(fields: [containerSize], references: [shortName])
  originPort            tlkp_originPort?      @relation(fields: [portOfOrigin], references: [shortName])
  destPort              tlkp_destinationPort? @relation(fields: [destinationPort], references: [shortName])
  bookingAgentLookup    tlkp_bookingAgent?    @relation(fields: [bookingAgent], references: [shortName])
  deliveryAddressLookup tlkp_deliveryAddress? @relation(fields: [deliveryAddress], references: [shortName])

  // Products on this shipment
  shipmentProducts tbljn_shipment_company_rslModel[]

  // Purchase orders associated with this shipment
  purchaseOrders tbljn_shipment_purchaseOrder[]
}

/**
 * Logistics user accounts
 */
model tbl_logisticsUser {
  id          Int     @id @default(autoincrement())
  email       String  @unique
  displayName String?
  userType    String // "RSL Internal" | "RSL Supplier"
  isActive    Boolean @default(true)
  companyID   String
  password    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Company this user is associated with (by company shortName)
  company tlkp_company? @relation(fields: [companyID], references: [shortName])

  // Many-to-many permissions via join table
  permissionLinks    tbljn_logisticsUser_permission[]
  purchaseOrderNotes tbl_purchaseOrderNotes[]
}

/**
 * Purchase Order history notes (notes-only; notes may optionally carry a PDF URL when a PDF is uploaded)
 */
model tbl_purchaseOrderNotes {
  id Int @id @default(autoincrement())

  // Which PO this note belongs to (business key)
  purchaseOrderGID String

  // Author (nullable allows system notes; SetNull if user is deleted)
  userId Int?

  createdAt DateTime @default(now())

  // Note content (also used as "Reason for Update")
  content String @db.Text

  // If this note corresponds to a PDF upload, store the uploaded PDF URL for historical versions
  pdfUrl String? @db.Text

  // Optional: helps UI show filename
  pdfFileName String? @db.VarChar(255)

  // Optional metadata (can also infer pdf update via pdfUrl != null)
  eventType String? @db.VarChar(30) // e.g. "NOTE" | "PDF_UPDATE"

  purchaseOrder tbl_purchaseOrder  @relation(fields: [purchaseOrderGID], references: [purchaseOrderGID], onDelete: Cascade, onUpdate: Cascade)
  logisticsUser tbl_logisticsUser? @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([purchaseOrderGID])
  @@index([userId])
  @@index([createdAt])
}

/**
 * Join: logistics user <-> permissions
 */
model tbljn_logisticsUser_permission {
  id              Int @id @default(autoincrement())
  logisticsUserID Int
  permissionID    Int

  logisticsUser tbl_logisticsUser @relation(fields: [logisticsUserID], references: [id])
  permission    tlkp_permission   @relation(fields: [permissionID], references: [id])

  @@index([logisticsUserID])
  @@index([permissionID])
}

/**
 * Join: shipment <-> company <-> RSL model
 * Quantity is per line
 */
model tbljn_shipment_company_rslModel {
  id         Int    @id @default(autoincrement())
  shipmentID String
  companyID  String
  rslModelID String
  quantity   Int

  // We assume shipmentID stores the containerNumber code
  shipment tbl_shipment  @relation(fields: [shipmentID], references: [containerNumber])
  // Company & product by shortName
  company  tlkp_company  @relation(fields: [companyID], references: [shortName])
  rslModel tlkp_rslModel @relation(fields: [rslModelID], references: [shortName])

  @@index([shipmentID])
  @@index([companyID])
  @@index([rslModelID])
}

/**
 * Join: company <-> RSL model (products allocated to shipper)
 */
model tbljn_company_rslModel {
  id         Int    @id @default(autoincrement())
  companyID  String
  rslModelID String

  company  tlkp_company  @relation(fields: [companyID], references: [shortName])
  rslModel tlkp_rslModel @relation(fields: [rslModelID], references: [shortName])

  @@index([companyID])
  @@index([rslModelID])
}

/**
 * Join: shipment <- purchase orders
 */
model tbljn_shipment_purchaseOrder {
  id Int @id @default(autoincrement())

  // Weâ€™ll join by business keys, not numeric IDs:
  // - shipmentID references tbl_shipment.containerNumber
  // - purchaseOrderGID references tbl_purchaseOrder.purchaseOrderGID
  shipmentID       String
  purchaseOrderGID String

  shipment      tbl_shipment      @relation(fields: [shipmentID], references: [containerNumber])
  purchaseOrder tbl_purchaseOrder @relation(fields: [purchaseOrderGID], references: [purchaseOrderGID])

  @@index([shipmentID])
  @@index([purchaseOrderGID])
}

model tbljn_purchaseOrder_company {
  id               Int    @id @default(autoincrement())
  purchaseOrderGID String
  companyID        String

  purchaseOrder tbl_purchaseOrder @relation(fields: [purchaseOrderGID], references: [purchaseOrderGID], onDelete: Cascade, onUpdate: Cascade)
  company       tlkp_company      @relation(fields: [companyID], references: [shortName], onDelete: Cascade, onUpdate: Cascade)

  @@unique([purchaseOrderGID, companyID])
  @@index([purchaseOrderGID])
  @@index([companyID])
}

/**
 * Purchase Orders (main data table)
 */
model tbl_purchaseOrder {
  id               Int    @id @default(autoincrement())
  shortName        String @unique
  purchaseOrderGID String @unique

  // Current / latest PDF URL (Shopify CDN)
  purchaseOrderPdfUrl String?

  // timestamps for detail page
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shipmentLinks tbljn_shipment_purchaseOrder[]
  companyLinks  tbljn_purchaseOrder_company[]

  // history notes
  notes tbl_purchaseOrderNotes[]
}

/**
 * Lookups
 */

model tlkp_rslModel {
  id          Int    @id @default(autoincrement())
  shortName   String @unique
  displayName String
  SKU         String @unique

  // Back-relations
  companyLinks     tbljn_company_rslModel[]
  shipmentProducts tbljn_shipment_company_rslModel[]
}

model tlkp_company {
  id               Int     @id @default(autoincrement())
  shortName        String  @unique
  displayName      String?
  address1         String?
  address2         String?
  city             String?
  province         String?
  postalCode       String?
  country          String?
  primaryContact   String?
  primaryPhone     String?
  primaryEmail     String?
  supplierCurrency String?

  shipments        tbl_shipment[]
  logisticsUsers   tbl_logisticsUser[]
  products         tbljn_company_rslModel[]
  shipmentProducts tbljn_shipment_company_rslModel[]

  purchaseOrders tbljn_purchaseOrder_company[]
}

model tlkp_bookingAgent {
  id           Int            @id @default(autoincrement())
  shortName    String         @unique
  displayName  String?
  tbl_shipment tbl_shipment[]
}

model tlkp_container {
  id          Int    @id @default(autoincrement())
  shortName   String @unique
  displayName String

  shipments tbl_shipment[]
}

model tlkp_originPort {
  id          Int     @id @default(autoincrement())
  shortName   String  @unique
  displayName String?

  shipments tbl_shipment[]
}

model tlkp_destinationPort {
  id          Int     @id @default(autoincrement())
  shortName   String  @unique
  displayName String?

  shipments tbl_shipment[]
}

model tlkp_deliveryAddress {
  id           Int            @id @default(autoincrement())
  shortName    String         @unique
  displayName  String?
  tbl_shipment tbl_shipment[]
}

model tlkp_permission {
  id          Int    @id @default(autoincrement())
  shortName   String @unique
  displayName String

  userLinks tbljn_logisticsUser_permission[]
}
