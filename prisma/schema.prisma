generator client {
  provider   = "prisma-client-js"
  engineType = "library" // or "binary" (either is fine on Node)
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)

  @@index([shop]) // speeds up lookups by shop
  @@index([expires]) // helps periodic cleanup of expired sessions
}

model tblkp_staff {
  id   Int     @id @default(autoincrement())
  name String? @db.VarChar(60)
  role String? @db.VarChar(60)
  gid  String? @db.VarChar(60)

  @@map("rsl_staff")
}

/**
 * Core shipment data
 */
model tbl_shipment {
  id                        Int       @id @default(autoincrement())
  companyId                 String
  companyName               String
  containerNumber           String    @unique
  containerSize             String?
  portOfOrigin              String?
  destinationPort           String?
  etaDate                   DateTime?
  cargoReadyDate            DateTime?
  estimatedDeliveryToOrigin DateTime?
  supplierPi                String?
  quantity                  BigInt?
  bookingNumber             String?
  status                    String?
  notes                     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // --- Relations ---
  company    tlkp_company?         @relation(fields: [companyId], references: [shortName])
  container  tlkp_container?       @relation(fields: [containerSize], references: [shortName])
  originPort tlkp_originPort?      @relation(fields: [portOfOrigin], references: [shortName])
  destPort   tlkp_destinationPort? @relation(fields: [destinationPort], references: [shortName])

  // Products on this shipment
  shipmentLines tbljn_shipment_company_rslModel[]

  // Purchase orders associated with this shipment
  purchaseOrders tbljn_shipment_purchaseOrder[]
}

/**
 * Logistics user accounts
 */
model tbl_logisticsUser {
  id          Int     @id @default(autoincrement())
  email       String  @unique
  displayName String?
  userType    String // "RSL Internal" | "RSL Supplier"
  isActive    Boolean @default(true)
  companyID   String
  password    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Company this user is associated with (by company shortName)
  company tlkp_company? @relation(fields: [companyID], references: [shortName])

  // Many-to-many permissions via join table
  permissionLinks tbljn_logisticsUser_permission[]
}

/**
 * Join: logistics user <-> permissions
 */
model tbljn_logisticsUser_permission {
  id              Int @id @default(autoincrement())
  logisticsUserID Int
  permissionID    Int

  logisticsUser tbl_logisticsUser @relation(fields: [logisticsUserID], references: [id])
  permission    tlkp_permission   @relation(fields: [permissionID], references: [id])

  @@index([logisticsUserID])
  @@index([permissionID])
}

/**
 * Join: shipment <-> company <-> RSL model
 * Quantity is per line
 */
model tbljn_shipment_company_rslModel {
  id         Int    @id @default(autoincrement())
  shipmentID String
  companyID  String
  rslModelID String
  quantity   Int

  // We assume shipmentID stores the containerNumber code
  shipment tbl_shipment  @relation(fields: [shipmentID], references: [containerNumber])
  // Company & product by shortName
  company  tlkp_company  @relation(fields: [companyID], references: [shortName])
  rslModel tlkp_rslModel @relation(fields: [rslModelID], references: [shortName])

  @@index([shipmentID])
  @@index([companyID])
  @@index([rslModelID])
}

/**
 * Join: company <-> RSL model (products allocated to shipper)
 */
model tbljn_company_rslModel {
  id         Int    @id @default(autoincrement())
  companyID  String
  rslModelID String

  company  tlkp_company  @relation(fields: [companyID], references: [shortName])
  rslModel tlkp_rslModel @relation(fields: [rslModelID], references: [shortName])

  @@index([companyID])
  @@index([rslModelID])
}

/**
 * Join: shipment <- purchase orders
 */
model tbljn_shipment_purchaseOrder {
  id Int @id @default(autoincrement())

  // Weâ€™ll join by business keys, not numeric IDs:
  // - shipmentID references tbl_shipment.containerNumber
  // - purchaseOrderGID references tlkp_purchaseOrder.purchaseOrderGID
  shipmentID       String
  purchaseOrderGID String

  shipment      tbl_shipment       @relation(fields: [shipmentID], references: [containerNumber])
  purchaseOrder tlkp_purchaseOrder @relation(fields: [purchaseOrderGID], references: [purchaseOrderGID])

  @@index([shipmentID])
  @@index([purchaseOrderGID])
}

/**
 * Lookups
 */

model tlkp_purchaseOrder {
  id               Int    @id @default(autoincrement())
  shortName        String @unique
  purchaseOrderGID String @unique

  // NEW: shipments using this PO
  shipmentLinks tbljn_shipment_purchaseOrder[]
}

model tlkp_rslModel {
  id          Int    @id @default(autoincrement())
  shortName   String @unique
  displayName String
  SKU         String @unique

  // Back-relations
  companyLinks  tbljn_company_rslModel[]
  shipmentLines tbljn_shipment_company_rslModel[]
}

model tlkp_company {
  id               Int     @id @default(autoincrement())
  shortName        String  @unique
  displayName      String?
  address1         String?
  address2         String?
  city             String?
  province         String?
  postalCode       String?
  country          String?
  primaryContact   String?
  primaryPhone     String?
  primaryEmail     String?
  supplierCurrency String?

  // Back-relations
  shipments      tbl_shipment[]
  logisticsUsers tbl_logisticsUser[]
  products       tbljn_company_rslModel[]
  shipmentLines  tbljn_shipment_company_rslModel[]
}

model tlkp_bookingAgent {
  id          Int     @id @default(autoincrement())
  shortName   String  @unique
  displayName String?
}

model tlkp_container {
  id          Int    @id @default(autoincrement())
  shortName   String @unique
  displayName String

  shipments tbl_shipment[]
}

model tlkp_originPort {
  id          Int     @id @default(autoincrement())
  shortName   String  @unique
  displayName String?

  shipments tbl_shipment[]
}

model tlkp_destinationPort {
  id          Int     @id @default(autoincrement())
  shortName   String  @unique
  displayName String?

  shipments tbl_shipment[]
}

model tlkp_deliveryAddress {
  id          Int     @id @default(autoincrement())
  shortName   String  @unique
  displayName String?
}

model tlkp_permission {
  id          Int    @id @default(autoincrement())
  shortName   String @unique
  displayName String

  userLinks tbljn_logisticsUser_permission[]
}
